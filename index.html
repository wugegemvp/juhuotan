<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èšç«æ½­äº‘ç«¯ç‰ˆ (Online)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>

    <script src="http://localhost:8000/CLodopfuncs.js"></script>
    <script src="http://localhost:18000/CLodopfuncs.js"></script>

    <style>
        /* --- 1. åŸºç¡€å˜é‡ --- */
        :root { 
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --primary: #000;
            --danger: #c0392b;
            --accent: #d35400;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; 
            background: var(--bg-body); 
            margin: 0; padding: 0; 
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- é¡¶éƒ¨æ ‡é¢˜æ  --- */
        .top-header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10;
        }
        .app-title { margin:0; font-size:18px; font-weight:900; display: flex; align-items: center; gap: 5px; }
        .version-tag { font-size:10px; background:var(--accent); color:#fff; padding:2px 4px; border-radius:4px; }
        
        .sys-actions { display: flex; gap: 8px; align-items: center; }
        .sys-actions .btn-sm { padding: 6px 10px; font-size: 12px; }
        .stock-info { font-size: 12px; font-weight: bold; color: #666; } 

        /* --- 2. æœç´¢åŒºåŸŸ --- */
        .search-bar-row {
            background: var(--bg-card); 
            padding: 10px;
            display: flex; flex-direction: column; gap: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .search-input { 
            width: 100%; padding: 12px; font-size: 16px; font-weight: bold; 
            border: 2px solid #ccc; border-radius: 8px; outline: none; appearance: none;
        }
        .search-input:focus { border-color: var(--primary); }

        .exclude-group { width: 100%; }
        .input-exclude {
            width: 100%; padding: 10px; font-size: 14px; 
            border: 1px solid #e74c3c; border-radius: 8px;
            background: #fff5f5; color: #c0392b;
        }

        /* --- 3. æ“ä½œè¡Œ (å·¥å…·æ ) --- */
        .middle-toolbar {
            background: #e8eaf6; padding: 10px; 
            display: flex; gap: 8px; overflow-x: auto; white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        .middle-toolbar::-webkit-scrollbar { display: none; }

        .btn-flash-print {
            flex-shrink: 0; height: 44px; padding: 0 20px; font-size: 15px; font-weight: 900; 
            border-radius: 22px; background: var(--primary); color: #fff; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .btn-normal {
            flex-shrink: 0; height: 44px; padding: 0 15px; font-size: 13px; font-weight: bold; 
            border-radius: 8px; background: #fff; color: #333; border: 1px solid #ccc;
        }

        .sel-wrapper { 
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
            display: flex; flex-direction: column; gap: 5px; align-items: flex-end;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
            transform: scale(0.9);
        }
        .sel-wrapper.show { opacity: 1; pointer-events: auto; transform: scale(1); }
        .sel-tag { 
            background: var(--accent); color: #fff; border: none; 
            padding: 8px 20px; border-radius: 30px; font-weight: bold; font-size: 14px; 
            box-shadow: 0 4px 12px rgba(211, 84, 0, 0.4);
        }
        .btn-clear-sel { 
            height: 36px; padding: 0 15px; font-size: 12px; font-weight: bold; 
            background: #fff; color: var(--danger); border: 1px solid #eee; 
            border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* --- åˆ—è¡¨åŒºåŸŸ --- */
        .result-list { 
            flex: 1; overflow-y: auto; background: #f0f2f5; padding: 10px; 
            -webkit-overflow-scrolling: touch;
        }

        .item { 
            background: #fff; border-radius: 8px; margin-bottom: 10px; padding: 12px;
            display: flex; flex-direction: column; gap: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid transparent;
        }
        .item.selected { background: #e6f7ff !important; border-color: #1890ff; }
        .item.selected .item-name { color: #c0392b; }

        .item-top { display: flex; align-items: flex-start; gap: 10px; }
        .item-checkbox { transform: scale(1.5); margin-top: 4px; }
        .item-idx { font-size: 12px; color: #999; background: #eee; padding: 2px 6px; border-radius: 4px; height: fit-content;}
        .item-name { flex: 1; font-weight: bold; font-size: 16px; line-height: 1.4; word-break: break-all; }
        
        .item-btm { 
            display: flex; justify-content: space-between; margin-top: 5px; 
            padding-top: 5px; border-top: 1px dashed #eee; font-size: 13px; color: #666;
        }
        .tag-pill { background: #f0f0f0; padding: 2px 8px; border-radius: 4px; font-weight: bold; }

        /* å¼¹çª— */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); display: none; z-index: 2000; 
            justify-content: center; align-items: flex-end;
        }
        .modal-content { 
            background: white; width: 100%; border-radius: 16px 16px 0 0; 
            padding: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.2); 
            max-height: 90vh; display: flex; flex-direction: column; gap: 15px; 
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* åå¸æç¤º */
        #toast { 
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.85); color: white; padding: 15px 25px; 
            border-radius: 30px; font-size: 16px; font-weight: bold; z-index: 6000; 
            opacity: 0; pointer-events: none; transition: opacity 0.2s; 
            width: 80%; text-align: center;
        }
        #toast.active { opacity: 1; }

        .btn-sm { border:1px solid #ccc; padding:6px 12px; border-radius:4px; font-weight:bold; background:#fff; }
        .btn-brain { background:#3498db; color:#fff; border:none; }
        .btn-danger-sm { color:red; border-color:red; }

        @media (min-width: 769px) {
            .modal { align-items: center; }
            .modal-content { width: 500px; border-radius: 8px; max-height: 80vh; }
            .search-bar-row { flex-direction: row; }
        }
    </style>
</head>
<body>

    <div class="top-header">
        <h1 class="app-title">
            <span>ğŸ”¥ èšç«æ½­äº‘ç«¯</span> 
            <span class="version-tag">Online</span>
        </h1>
        <div class="sys-actions">
            <span class="stock-info">å…± <span id="dbCountDisp">0</span> æ¡</span>
            <button class="btn-sm btn-brain" onclick="alert('äº‘ç«¯ç‰ˆç›®å‰ä»…æ”¯æŒç²¾ç¡®æœç´¢ï¼Œåˆ«ååŠŸèƒ½å¼€å‘ä¸­...')">è®­ç»ƒ</button>
            <button class="btn-sm" onclick="openImport()">å¯¼å…¥</button>
            <button class="btn-sm btn-danger-sm" onclick="clearDB()">æ¸…ç©º</button>
        </div>
    </div>

    <div class="search-bar-row">
        <div class="search-group" style="flex:1">
            <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœ: P40 è“è‰² (äº‘ç«¯åŒæ­¥)" autofocus>
        </div>
        <div class="exclude-group" style="flex:1">
            <input type="text" id="excludeInput" class="input-exclude" placeholder="ğŸš« æ’: å çƒ‚">
        </div>
    </div>

    <div class="middle-toolbar">
        <button class="btn-flash-print" onclick="quickDirectPrint()">âš¡ï¸ ç›´æ¥æ‰“å°</button>
        <button class="btn-normal" onclick="openPrintModal()">âš™ï¸ è®¾ç½®/é¢„è§ˆ</button>
    </div>

    <div class="sel-wrapper" id="selWrapper">
        <div class="sel-tag">å·²é€‰ <b id="selCount" style="margin:0 4px;">0</b></div>
        <button class="btn-clear-sel" onclick="clearSelection()">æ¸…ç©º</button>
    </div>

    <div id="resultList" class="result-list">
        <div style="text-align:center; padding:40px; color:#999;">â˜ï¸ æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®åº“...</div>
    </div>

    <div id="toast">âœ… å·²å¤åˆ¶</div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“¥ æ‰¹é‡å¯¼å…¥ (å­˜å…¥äº‘ç«¯)</h3>
            <textarea id="importArea" style="width:100%; height:150px; padding:10px; border:1px solid #ccc; border-radius:8px;" placeholder="ç²˜è´´Excelå†…å®¹ï¼šåç§° | ä¸»ä»“ | å‰¯ä»“"></textarea>
            <div style="font-size:12px; color:#666;">* å»ºè®®æ¯æ¬¡å¯¼å…¥ä¸è¶…è¿‡ 500 æ¡</div>
            <div style="display:flex; gap:10px; width:100%;">
                <button class="btn-normal" style="flex:1" onclick="closeImport()">å–æ¶ˆ</button>
                <button class="btn-flash-print" style="flex:1" onclick="saveImport()">â˜ï¸ ä¸Šä¼ äº‘ç«¯</button>
            </div>
        </div>
    </div>

    <div id="printModal" class="modal">
        <div class="modal-content">
            <h3 style="margin:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ–¨ï¸ æ‰“å°è®¾ç½®</h3>
            <div style="background:#fff3cd; padding:10px; border-radius:4px; font-size:12px; color:#856404;">
                âš ï¸ æ‰‹æœºæ‰“å°éœ€ç”µè„‘å¼€å¯ C-Lodop æœåŠ¡ï¼Œä¸”åœ¨åŒä¸€å±€åŸŸç½‘ã€‚
            </div>
            <label style="font-weight:bold; font-size:14px;">é€‰æ‹©æ‰“å°æœº:</label>
            <select id="printerSelect" style="width:100%; padding:10px; border:2px solid #ccc; border-radius:4px; font-size:16px; background:#fff;">
                <option>åŠ è½½ä¸­...</option>
            </select>
            <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                <label style="font-weight:bold;">æ¯æ¬¾æ•°é‡:</label>
                <button class="btn-normal" onclick="adjQty(-1)">-</button>
                <input type="number" id="globalQty" value="1" min="1" style="width:60px; text-align:center; padding:10px; border:2px solid #000; border-radius:4px; font-weight:bold;">
                <button class="btn-normal" onclick="adjQty(1)">+</button>
            </div>
            <div class="print-list" id="printListArea" style="max-height:150px;overflow-y:auto;border:1px solid #eee;margin-top:10px;"></div>
            <div style="display:flex; gap:10px; margin-top:auto;">
                <button class="btn-normal" style="flex:1;" onclick="closePrint()">å–æ¶ˆ</button>
                <button class="btn-flash-print" style="flex:1;" onclick="confirmPrint('PRINT')">æ‰“å°</button>
            </div>
        </div>
    </div>

<script>
    // ============================================================
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä½ çš„ LeanCloud é’¥åŒ™ (å·²è‡ªåŠ¨å¡«å¥½) ğŸ‘‡ğŸ‘‡ğŸ‘‡
    // ============================================================
    const LC_APP_ID  = "t2oaqogctST7YXDBw27y5VRJ-gzGzoHsz";
    const LC_APP_KEY = "4QbfWe7IBPLDu8DRzyUwDEqo";
    const LC_SERVER  = "https://t2oaqogc.lc-cn-n1-shared.com";
    // ============================================================

    let allData=[], currentResults=[], selectedIds=new Set();
    
    // åˆå§‹åŒ–äº‘ç«¯
    window.onload = () => {
        try {
            AV.init({ appId: LC_APP_ID, appKey: LC_APP_KEY, serverURL: LC_SERVER });
            console.log("äº‘ç«¯è¿æ¥æˆåŠŸ");
            loadDataCloud(); 
        } catch(e) {
            alert("äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ï¼");
        }
        
        document.getElementById('searchInput').addEventListener('input', handleInput);
        document.getElementById('excludeInput').addEventListener('input', handleInput);
    };

    // --- äº‘ç«¯æ•°æ®æ“ä½œ ---

    // 1. ä»äº‘ç«¯æ‹‰å–æ•°æ®
    function loadDataCloud() {
        showToast("â˜ï¸ æ­£åœ¨åŒæ­¥æ•°æ®...");
        const query = new AV.Query('Product');
        query.limit(1000); // æ¯æ¬¡æœ€å¤šå–1000æ¡
        query.descending('updatedAt'); // æŒ‰æ›´æ–°æ—¶é—´å€’åº
        
        query.find().then((results) => {
            allData = results.map(r => ({
                id: r.id, // äº‘ç«¯çš„å”¯ä¸€ID
                name: r.get('name'),
                main: r.get('main'),
                sub: r.get('sub')
            }));
            document.getElementById('dbCountDisp').innerText = allData.length;
            renderListCurrent();
            showToast("âœ… åŒæ­¥å®Œæˆ");
        }).catch((error) => {
            console.error(error);
            document.getElementById('resultList').innerHTML = `<div style="text-align:center;padding:20px;color:red;">æ•°æ®è·å–å¤±è´¥<br>${error.message}</div>`;
        });
    }

    // 2. ä¸Šä¼ æ•°æ®åˆ°äº‘ç«¯
    function saveImport() { 
        const txt = document.getElementById('importArea').value;
        const lines = txt.split('\n');
        let objectsToSave = [];

        lines.forEach(l => {
            const p = l.split(/\t|\|/); // æ”¯æŒ Tab æˆ– | åˆ†éš”
            if(p[0]?.trim()){
                // åˆ›å»ºä¸€ä¸ª Product å¯¹è±¡
                const product = new AV.Object('Product');
                product.set('name', p[0].trim());
                product.set('main', p[1]?.trim()||'');
                product.set('sub', p[2]?.trim()||'');
                objectsToSave.push(product);
            }
        });

        if(objectsToSave.length === 0) return showToast("æ²¡æ£€æµ‹åˆ°æœ‰æ•ˆæ•°æ®");

        showToast(`æ­£åœ¨ä¸Šä¼  ${objectsToSave.length} æ¡...`);
        
        // æ‰¹é‡ä¿å­˜
        AV.Object.saveAll(objectsToSave).then(() => {
            showToast("âœ… ä¸Šä¼ æˆåŠŸï¼");
            closeImport();
            loadDataCloud(); // é‡æ–°æ‹‰å–
        }).catch((error) => {
            alert("ä¸Šä¼ å¤±è´¥ï¼š" + error.message);
        });
    }

    // 3. æ¸…ç©ºäº‘ç«¯æ•°æ®
    function clearDB() {
        if(!confirm('âš ï¸ é«˜èƒ½é¢„è­¦ï¼šè¿™å°†åˆ é™¤äº‘ç«¯æ‰€æœ‰æ•°æ®ï¼\nç”µè„‘å’Œæ‰‹æœºéƒ½ä¼šå˜ç©ºï¼ç¡®å®šå—ï¼Ÿ')) return;
        
        showToast("æ­£åœ¨åˆ é™¤...");
        const query = new AV.Query('Product');
        query.limit(1000);
        query.find().then((results) => {
            return AV.Object.destroyAll(results);
        }).then(() => {
            showToast("âœ… å·²æ¸…ç©º");
            allData = [];
            renderListCurrent();
            document.getElementById('dbCountDisp').innerText = 0;
        }).catch((error) => {
            alert("åˆ é™¤å¤±è´¥ï¼š" + error.message);
        });
    }

    // --- æœ¬åœ°é€»è¾‘ ---

    function handleInput() {
        if(selectedIds.size > 0) { selectedIds.clear(); updateFooter(); }
        renderListCurrent(); 
    }

    function renderListCurrent() {
        const inc = document.getElementById('searchInput').value.trim().toLowerCase().split(/\s+/);
        const exc = document.getElementById('excludeInput').value.trim().toLowerCase().split(/\s+/);
        
        let res = allData;
        const validInc = inc.filter(k=>k); const validExc = exc.filter(k=>k);
        
        if(validInc.length > 0 || validExc.length > 0) {
            res = allData.filter(d => {
                const name = d.name.toLowerCase();
                const matchInc = validInc.length === 0 || validInc.every(k => name.includes(k));
                const matchExc = validExc.length > 0 && validExc.some(k => name.includes(k));
                return matchInc && !matchExc;
            });
        }
        
        currentResults = res;
        const list = document.getElementById('resultList');
        if(!res.length) { list.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">ğŸ” æ²¡æ‰¾åˆ°...</div>'; return; }
        
        let h = '';
        res.slice(0, 50).forEach((item, idx) => { 
            const isSel = selectedIds.has(item.name);
            const safeName = item.name.replace(/"/g, "&quot;");
            h += `
            <div class="item ${isSel?'selected':''}" onclick="toggleRow('${safeName}')">
                <div class="item-top">
                    <input type="checkbox" class="item-checkbox" ${isSel?'checked':''} readonly>
                    <span class="item-idx">${idx+1}</span>
                    <div class="item-name">${item.name}</div>
                </div>
                <div class="item-btm">
                    <span class="tag-pill">ğŸ  ${item.main||'-'}</span>
                    <span class="tag-pill">ğŸ­ ${item.sub||'-'}</span>
                </div>
            </div>`;
        });
        if(res.length > 50) h += '<div style="text-align:center;padding:10px;color:#ccc;">ä»…æ˜¾ç¤ºå‰50æ¡</div>';
        list.innerHTML = h;
    }

    function toggleRow(name) {
        if (selectedIds.has(name)) selectedIds.delete(name); else selectedIds.add(name);
        updateFooter(); renderListCurrent();
    }
    
    function updateFooter() { 
        const c = selectedIds.size; document.getElementById('selCount').innerText = c;
        const w = document.getElementById('selWrapper');
        if(c>0) w.classList.add('show'); else w.classList.remove('show');
    }
    function clearSelection() { selectedIds.clear(); updateFooter(); renderListCurrent(); showToast('å·²æ¸…ç©ºé€‰æ‹©'); }

    /* --- å¼¹çª—ä¸æ‰“å°é€»è¾‘ --- */
    function openImport(){document.getElementById('importModal').style.display='flex';}
    function closeImport(){document.getElementById('importModal').style.display='none';}
    function showToast(msg){ const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('active'); setTimeout(()=>t.classList.remove('active'), 1500); }

    function adjQty(n){ 
        const el = document.getElementById('globalQty'); 
        let v = parseInt(el.value)+n; 
        if(v<1)v=1; el.value=v; 
    }
    
    function openPrintModal() { 
        if(selectedIds.size === 0) return showToast('è¯·å…ˆé€‰æ‹©å•†å“');
        document.getElementById('printModal').style.display='flex'; 
        const list = document.getElementById('printListArea'); list.innerHTML = '';
        selectedIds.forEach(name => { list.innerHTML += `<div class="print-item">${name}</div>`; });
        
        setTimeout(()=>{
            const sel = document.getElementById('printerSelect');
            if(typeof getCLodop !== 'function') { sel.innerHTML='<option>âŒ æœªè¿æ¥C-Lodop</option>'; return; }
            try { 
                const LODOP = getCLodop(); const c = LODOP.GET_PRINTER_COUNT(); let h=''; 
                const saved = localStorage.getItem('DefaultPrinterIndex');
                for(let i=0;i<c;i++) h+=`<option value="${i}" ${saved==i?'selected':''}>${LODOP.GET_PRINTER_NAME(i)}</option>`;
                sel.innerHTML = h; 
            } catch(e) { sel.innerHTML='<option>âŒ é”™è¯¯</option>'; }
        }, 500);
    }
    function closePrint(){ document.getElementById('printModal').style.display='none'; }
    function quickDirectPrint() {
        if(selectedIds.size === 0) return showToast('è¯·å…ˆé€‰æ‹©');
        if(!localStorage.getItem('DefaultPrinterIndex')) return showToast('è¯·å…ˆè¿›å…¥è®¾ç½®é€‰æ‹©æ‰“å°æœº');
        confirmPrint('DIRECT');
    }

    // æ‰“å°é…ç½®
    const printConfig = [ 
        {type:'qrcode', x:2, y:2, w:26, h:26}, 
        {type:'text', val:'{å•†å“å}', x:32, y:5, w:180, h:24, fs:13, bold:true},
        {type:'text', val:'{ä¸»ä»“}', x:32, y:30, w:100, h:20, fs:16, bold:true},
        {type:'text', val:'{å‰¯ä»“}', x:92, y:34, w:60, h:15, fs:12, bold:true}
    ];

    function confirmPrint(mode) {
        if(typeof getCLodop !== 'function') return alert('æœªæ‰¾åˆ°æ‰“å°æœåŠ¡ (C-Lodop)\nç”µè„‘éœ€å¼€å¯C-Lodopï¼Œä¸”æ‰‹æœºéœ€åœ¨åŒWifiã€‚');
        const LODOP = getCLodop();
        let pIdx = document.getElementById('printerSelect').value;
        if(mode === 'DIRECT') pIdx = localStorage.getItem('DefaultPrinterIndex');
        else localStorage.setItem('DefaultPrinterIndex', pIdx);

        const qty = parseInt(document.getElementById('globalQty').value) || 1;
        const dateStr = new Date().toLocaleDateString();

        LODOP.PRINT_INIT("Cloud_Print_Task");
        if(pIdx) LODOP.SET_PRINTER_INDEX(pIdx);
        LODOP.SET_PRINT_PAGESIZE(1, "60mm", "40mm", ""); 

        selectedIds.forEach(name => {
            const data = allData.find(d => d.name === name) || {};
            for(let i=0; i<qty; i++) {
                LODOP.NewPage();
                printConfig.forEach(el => {
                    if(el.type === 'qrcode') {
                        LODOP.ADD_PRINT_BARCODE(el.y, el.x, el.w, el.h, "QRCode", name);
                    } else {
                        let txt = el.val.replace('{å•†å“å}', name).replace('{ä¸»ä»“}', data.main||'').replace('{å‰¯ä»“}', data.sub||'');
                        LODOP.ADD_PRINT_TEXT(el.y, el.x, el.w, el.h, txt);
                        LODOP.SET_PRINT_STYLEA(0, "FontSize", el.fs);
                        if(el.bold) LODOP.SET_PRINT_STYLEA(0, "Bold", 1);
                    }
                });
            }
        });
        if(mode !== 'PREVIEW') { LODOP.PRINT(); showToast('æŒ‡ä»¤å·²å‘é€'); } else LODOP.PREVIEW();
        closePrint();
    }
</script>
</body>
</html>


