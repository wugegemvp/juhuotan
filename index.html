<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èšç«æ½­äº‘ç«¯ç‰ˆ (V2.8)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>

    <script src="http://localhost:8000/CLodopfuncs.js"></script>
    <script src="http://localhost:18000/CLodopfuncs.js"></script>

    <style>
        /* --- 1. åŸºç¡€å˜é‡ --- */
        :root { 
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #000000; /* å…¨å±€å­—ä½“æ”¹çº¯é»‘ */
            --primary: #000;
            --danger: #c0392b;
            --accent: #d35400;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; 
            background: var(--bg-body); 
            margin: 0; padding: 0; 
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- é¡¶éƒ¨æ ‡é¢˜æ  --- */
        .top-header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10;
        }
        .app-title { margin:0; font-size:18px; font-weight:900; display: flex; align-items: center; gap: 5px; }
        .version-tag { font-size:10px; background:#000; color:#fff; padding:2px 4px; border-radius:4px; }
        
        .sys-actions { display: flex; gap: 8px; align-items: center; }
        .sys-actions .btn-sm { padding: 6px 10px; font-size: 12px; }
        
        /* --- 2. æœç´¢åŒºåŸŸ --- */
        .search-bar-row {
            background: var(--bg-card); 
            padding: 10px;
            display: flex; flex-direction: column; gap: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .search-input { 
            width: 100%; padding: 12px; font-size: 18px; font-weight: 900; /* æœç´¢æ¡†å­—ä¹ŸåŠ å¤§ */
            border: 2px solid #ccc; border-radius: 8px; outline: none; appearance: none;
            color: #000;
        }
        .search-input:focus { border-color: var(--primary); }

        .exclude-group { width: 100%; }
        .input-exclude {
            width: 100%; padding: 10px; font-size: 14px; 
            border: 1px solid #e74c3c; border-radius: 8px;
            background: #fff5f5; color: #c0392b;
        }

        /* --- 3. æ“ä½œè¡Œ --- */
        .middle-toolbar {
            background: #e8eaf6; padding: 10px; 
            display: flex; gap: 8px; overflow-x: auto; white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        .middle-toolbar::-webkit-scrollbar { display: none; }

        .btn-flash-print {
            flex-shrink: 0; height: 44px; padding: 0 20px; font-size: 15px; font-weight: 900; 
            border-radius: 22px; background: var(--primary); color: #fff; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .btn-normal {
            flex-shrink: 0; height: 44px; padding: 0 15px; font-size: 13px; font-weight: bold; 
            border-radius: 8px; background: #fff; color: #333; border: 1px solid #ccc;
        }

        .sel-wrapper { 
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
            display: flex; flex-direction: column; gap: 5px; align-items: flex-end;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
            transform: scale(0.9);
        }
        .sel-wrapper.show { opacity: 1; pointer-events: auto; transform: scale(1); }
        .sel-tag { 
            background: var(--accent); color: #fff; border: none; 
            padding: 8px 20px; border-radius: 30px; font-weight: bold; font-size: 14px; 
            box-shadow: 0 4px 12px rgba(211, 84, 0, 0.4);
        }
        .btn-clear-sel { 
            height: 36px; padding: 0 15px; font-size: 12px; font-weight: bold; 
            background: #fff; color: var(--danger); border: 1px solid #eee; 
            border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* --- åˆ—è¡¨åŒºåŸŸ (æ ¸å¿ƒä¿®æ”¹ï¼šå¤§å­—å·æ ·å¼) --- */
        .result-list { 
            flex: 1; overflow-y: auto; background: #f0f2f5; padding: 10px; 
            -webkit-overflow-scrolling: touch;
        }

        .item { 
            background: #fff; border-radius: 8px; margin-bottom: 10px; padding: 15px; /* åŠ å¤§å†…è¾¹è· */
            display: flex; flex-direction: column; gap: 8px; /* å¢åŠ é—´è· */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid transparent;
        }
        .item.selected { background: #fff8f0 !important; border-color: #d35400; }
        .item.selected .item-name { color: #d35400; }

        .item-top { display: flex; align-items: flex-start; gap: 12px; }
        .item-checkbox { transform: scale(1.6); margin-top: 5px; } /* å¤é€‰æ¡†ä¹ŸåŠ å¤§ */
        .item-idx { font-size: 12px; color: #999; background: #eee; padding: 2px 6px; border-radius: 4px; height: fit-content; margin-top: 3px;}
        
        /* ğŸ”¥ å•†å“åï¼šåŠ å¤§åŠ é»‘ */
        .item-name { 
            flex: 1; 
            font-weight: 900; 
            font-size: 18px; /* åŠ å¤§å­—å· */
            line-height: 1.4; 
            color: #000; /* çº¯é»‘ */
        }
        
        /* ğŸ”¥ åº“ä½æ˜¾ç¤ºåŒºåŸŸ */
        .item-btm { 
            display: flex; 
            justify-content: flex-start; /* å·¦å¯¹é½ */
            gap: 15px;
            margin-top: 5px; 
            padding-top: 5px; 
            /* border-top: 1px dashed #eee; å»æ‰åˆ†å‰²çº¿ï¼Œçœ‹èµ·æ¥æ›´è¿è´¯ */
            padding-left: 42px; /* è·Ÿä¸Šé¢çš„æ–‡å­—å¯¹é½ (é¿å¼€å¤é€‰æ¡†å®½åº¦) */
        }

        /* ğŸ”¥ åº“ä½æ ‡ç­¾ï¼šæ”¹æˆå¤§å­—çº¯æ–‡æœ¬é£æ ¼ */
        .tag-pill { 
            background: transparent; /* å»æ‰ç°è‰²èƒŒæ™¯ */
            padding: 0; 
            font-size: 18px; /* è·Ÿå•†å“åä¸€æ ·å¤§ï¼ */
            font-weight: 900; /* æœ€ç²— */
            color: #000; /* çº¯é»‘ */
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* å¼¹çª— */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); display: none; z-index: 2000; 
            justify-content: center; align-items: flex-end;
        }
        .modal-content { 
            background: white; width: 100%; border-radius: 16px 16px 0 0; 
            padding: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.2); 
            max-height: 90vh; display: flex; flex-direction: column; gap: 15px; 
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        #toast { 
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.85); color: white; padding: 15px 25px; 
            border-radius: 30px; font-size: 16px; font-weight: bold; z-index: 6000; 
            opacity: 0; pointer-events: none; transition: opacity 0.2s; 
            width: 80%; text-align: center;
        }
        #toast.active { opacity: 1; }

        @media (min-width: 769px) {
            .modal { align-items: center; }
            .modal-content { width: 500px; border-radius: 8px; max-height: 80vh; }
            .search-bar-row { flex-direction: row; }
            .item-btm { padding-left: 0; } /* ç”µè„‘ç«¯ä¸éœ€ç¼©è¿› */
        }
    </style>
</head>
<body>

    <div class="top-header">
        <h1 class="app-title">
            <span>ğŸ”¥ èšç«æ½­äº‘ç«¯</span> 
            <span class="version-tag">V2.8</span>
        </h1>
        <div class="sys-actions">
            <span class="stock-info">äº‘ç«¯å…± <span id="dbCountDisp">...</span> æ¡</span>
            <button class="btn-sm btn-normal" onclick="openImport()">å¯¼å…¥</button>
            <button class="btn-sm btn-normal" style="color:red;" onclick="clearDB()">æ¸…ç©º</button>
        </div>
    </div>

    <div class="search-bar-row">
        <div class="search-group" style="flex:1">
            <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœ: p40 é»‘è‰² (ä¸åˆ†å¤§å°å†™)" autofocus onkeydown="if(event.keyCode==13) doCloudSearch()">
        </div>
        <div class="exclude-group" style="flex:1">
            <input type="text" id="excludeInput" class="input-exclude" placeholder="ğŸš« æ’: å çƒ‚">
        </div>
    </div>

    <div class="middle-toolbar">
        <button class="btn-flash-print" onclick="quickDirectPrint()">âš¡ï¸ ç›´æ¥æ‰“å°</button>
        <button class="btn-normal" onclick="openPrintModal()">âš™ï¸ è®¾ç½®/é¢„è§ˆ</button>
    </div>

    <div class="sel-wrapper" id="selWrapper">
        <div class="sel-tag">å·²é€‰ <b id="selCount" style="margin:0 4px;">0</b></div>
        <button class="btn-clear-sel" onclick="clearSelection()">æ¸…ç©º</button>
    </div>

    <div id="resultList" class="result-list">
        <div style="text-align:center; padding:40px; color:#999;">â˜ï¸ æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...</div>
    </div>

    <div id="toast">âœ… å·²å¤åˆ¶</div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“¥ æ‰¹é‡å¯¼å…¥ (æ™ºèƒ½é˜²å¡æ­»)</h3>
            <textarea id="importArea" style="width:100%; height:150px; padding:10px; border:1px solid #ccc; border-radius:8px;" placeholder="ç²˜è´´Excelå†…å®¹ï¼šåç§° | ä¸»ä»“ | å‰¯ä»“"></textarea>
            <div style="font-size:12px; color:#666;">* ç¨‹åºä¼šè‡ªåŠ¨åˆ†æ‰¹ä¸Šä¼ ï¼Œè¯·è€å¿ƒç­‰å¾…è¿›åº¦æ¡èµ°å®Œ</div>
            <div style="display:flex; gap:10px; width:100%;">
                <button class="btn-normal" style="flex:1" onclick="closeImport()">å–æ¶ˆ</button>
                <button class="btn-flash-print" style="flex:1" onclick="saveImport()">â˜ï¸ å¼€å§‹ä¸Šä¼ </button>
            </div>
        </div>
    </div>

    <div id="printModal" class="modal">
        <div class="modal-content">
            <h3 style="margin:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ–¨ï¸ æ‰“å°è®¾ç½®</h3>
            <div style="background:#fff3cd; padding:10px; border-radius:4px; font-size:12px; color:#856404;">
                âš ï¸ æ‰‹æœºæ‰“å°éœ€ç”µè„‘å¼€å¯ C-Lodop æœåŠ¡ï¼Œä¸”åœ¨åŒä¸€å±€åŸŸç½‘ã€‚
            </div>
            <label style="font-weight:bold; font-size:14px;">é€‰æ‹©æ‰“å°æœº:</label>
            <select id="printerSelect" style="width:100%; padding:10px; border:2px solid #ccc; border-radius:4px; font-size:16px; background:#fff;">
                <option>åŠ è½½ä¸­...</option>
            </select>
            <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                <label style="font-weight:bold;">æ¯æ¬¾æ•°é‡:</label>
                <button class="btn-normal" onclick="adjQty(-1)">-</button>
                <input type="number" id="globalQty" value="1" min="1" style="width:60px; text-align:center; padding:10px; border:2px solid #000; border-radius:4px; font-weight:bold;">
                <button class="btn-normal" onclick="adjQty(1)">+</button>
            </div>
            <div class="print-list" id="printListArea" style="max-height:150px;overflow-y:auto;border:1px solid #eee;margin-top:10px;"></div>
            <div style="display:flex; gap:10px; margin-top:auto;">
                <button class="btn-normal" style="flex:1;" onclick="closePrint()">å–æ¶ˆ</button>
                <button class="btn-flash-print" style="flex:1;" onclick="confirmPrint('PRINT')">æ‰“å°</button>
            </div>
        </div>
    </div>

<script>
    // ============================================================
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä½ çš„ä¸“ç”¨é’¥åŒ™ (V2.8) ğŸ‘‡ğŸ‘‡ğŸ‘‡
    // ============================================================
    const LC_APP_ID  = "ZjVOXr4my7Gk7mqfDNyeWF8C-gzGzoHsz";
    const LC_APP_KEY = "UJn9xGwLPgzK0wmFvIBPUM8B";
    const LC_SERVER  = "https://zjvoxr4m.lc-cn-n1-shared.com";
    // ============================================================

    let previewData=[], selectedIds=new Set();
    let searchTimer = null;
    
    // åˆå§‹åŒ–äº‘ç«¯
    window.onload = () => {
        try {
            AV.init({ appId: LC_APP_ID, appKey: LC_APP_KEY, serverURL: LC_SERVER });
            loadInitData(); 
        } catch(e) {
            alert("äº‘ç«¯è¿æ¥å¤±è´¥ï¼š" + e.message);
        }
        
        // ç»‘å®šè¾“å…¥äº‹ä»¶ï¼ˆé˜²æŠ–ï¼‰
        document.getElementById('searchInput').addEventListener('input', (e) => {
             clearTimeout(searchTimer);
             searchTimer = setTimeout(doCloudSearch, 600); 
        });
        document.getElementById('excludeInput').addEventListener('input', doCloudSearch);
    };

    // --- æ ¸å¿ƒï¼šäº‘ç«¯æœç´¢é€»è¾‘ ---

    async function loadInitData() {
        const countQuery = new AV.Query('Product');
        countQuery.count().then(count => {
            document.getElementById('dbCountDisp').innerText = count;
        });

        const query = new AV.Query('Product');
        query.limit(50); 
        query.descending('updatedAt');
        
        query.find().then((results) => {
            previewData = results.map(r => ({ id:r.id, name:r.get('name'), main:r.get('main'), sub:r.get('sub') }));
            renderList(previewData, "ğŸ†• æœ€æ–°å…¥åº“ (ä»…æ˜¾ç¤ºå‰50æ¡)");
        });
    }

    function doCloudSearch() {
        const inputVal = document.getElementById('searchInput').value.trim();
        const excludeVal = document.getElementById('excludeInput').value.trim();
        
        if (!inputVal && !excludeVal) {
            renderList(previewData, "ğŸ†• æœ€æ–°å…¥åº“ (ä»…æ˜¾ç¤ºå‰50æ¡)");
            return;
        }

        document.getElementById('resultList').innerHTML = '<div style="text-align:center;padding:40px;color:#666;">â˜ï¸ æ­£åœ¨äº‘ç«¯æŸ¥æ‰¾...</div>';

        const keys = inputVal.split(/\s+/).filter(k => k);
        const exKeys = excludeVal.split(/\s+/).filter(k => k);

        let finalQuery;
        const escapeReg = (str) => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

        if (keys.length === 0) {
            finalQuery = new AV.Query('Product');
        } else {
            const subQueries = keys.map(k => {
                const q = new AV.Query('Product');
                q.matches('name', new RegExp(escapeReg(k), 'i'));
                return q;
            });
            if (subQueries.length === 1) {
                finalQuery = subQueries[0];
            } else {
                finalQuery = AV.Query.and(...subQueries);
            }
        }

        finalQuery.limit(100); 
        finalQuery.descending('updatedAt');

        finalQuery.find().then(results => {
            let list = results.map(r => ({ id:r.id, name:r.get('name'), main:r.get('main'), sub:r.get('sub') }));
            
            if (exKeys.length > 0) {
                const lowerExKeys = exKeys.map(k => k.toLowerCase());
                list = list.filter(item => {
                    const itemName = item.name.toLowerCase();
                    return !lowerExKeys.some(xk => itemName.includes(xk));
                });
            }

            renderList(list, list.length >= 100 ? "âš ï¸ ç»“æœè¿‡å¤šï¼Œå»ºè®®å¢åŠ å…³é”®è¯" : "");
        }).catch(e => {
            console.error(e);
            document.getElementById('resultList').innerHTML = `<div style="text-align:center;padding:20px;color:red;">ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</div>`;
        });
    }

    function renderList(data, tipText) {
        const list = document.getElementById('resultList');
        if(!data.length) { list.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">ğŸ” æœªæ‰¾åˆ°ç›¸å…³å•†å“</div>'; return; }
        
        let h = '';
        if(tipText) h += `<div style="padding:5px 10px; font-size:12px; color:#999; background:#eee;">${tipText}</div>`;

        data.forEach((item, idx) => { 
            const isSel = selectedIds.has(item.name);
            const safeName = item.name.replace(/"/g, "&quot;");
            h += `
            <div class="item ${isSel?'selected':''}" onclick="toggleRow('${safeName}')">
                <div class="item-top">
                    <input type="checkbox" class="item-checkbox" ${isSel?'checked':''} readonly>
                    <span class="item-idx">${idx+1}</span>
                    <div class="item-name">${item.name}</div>
                </div>
                <div class="item-btm">
                    <span class="tag-pill">ğŸ  ${item.main||'-'}</span>
                    <span class="tag-pill">ğŸ­ ${item.sub||'-'}</span>
                </div>
            </div>`;
        });
        list.innerHTML = h;
    }

    // --- ä¸Šä¼ /æ‰“å°é€»è¾‘ ---

    async function saveImport() { 
        const txt = document.getElementById('importArea').value;
        const lines = txt.split('\n');
        let objectsToSave = [];
        lines.forEach(l => {
            const p = l.split(/\t|\|/);
            if(p[0]?.trim()){
                const product = new AV.Object('Product');
                product.set('name', p[0].trim());
                product.set('main', p[1]?.trim()||'');
                product.set('sub', p[2]?.trim()||'');
                objectsToSave.push(product);
            }
        });
        const total = objectsToSave.length;
        if(total === 0) return showToast("æ²¡æ•°æ®");

        const BATCH_SIZE = 50; 
        let successCount = 0;
        const btn = document.querySelector('#importModal .btn-flash-print');
        const originalText = btn.innerText;
        btn.disabled = true;

        try {
            for (let i = 0; i < total; i += BATCH_SIZE) {
                const chunk = objectsToSave.slice(i, i + BATCH_SIZE);
                btn.innerText = `â³ ä¸Šä¼ ä¸­ ${i}/${total}...`;
                await AV.Object.saveAll(chunk);
                successCount += chunk.length;
                await new Promise(r => setTimeout(r, 200)); 
            }
            showToast(`âœ… æˆåŠŸå¯¼å…¥ ${successCount} æ¡ï¼`);
            closeImport();
            loadInitData();
        } catch (error) {
            alert("ä¸Šä¼ ä¸­æ–­ï¼š" + error.message);
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    function clearDB() {
        if(!confirm('âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ')) return;
        const query = new AV.Query('Product');
        query.limit(1000);
        query.find().then((results) => {
            return AV.Object.destroyAll(results);
        }).then(() => {
            showToast("âœ… å·²æ¸…ç©ºæœ¬é¡µæ•°æ®(éœ€å¤šæ¬¡æ‰§è¡Œ)");
            loadInitData();
        });
    }

    function toggleRow(name) {
        if (selectedIds.has(name)) selectedIds.delete(name); else selectedIds.add(name);
        updateFooter(); 
        const items = document.querySelectorAll('.item');
        items.forEach(el => {
            if(el.querySelector('.item-name').innerText === name) {
                if(selectedIds.has(name)) el.classList.add('selected'); else el.classList.remove('selected');
                el.querySelector('.item-checkbox').checked = selectedIds.has(name);
            }
        });
    }
    
    function updateFooter() { 
        const c = selectedIds.size; document.getElementById('selCount').innerText = c;
        const w = document.getElementById('selWrapper');
        if(c>0) w.classList.add('show'); else w.classList.remove('show');
    }
    function clearSelection() { selectedIds.clear(); updateFooter(); doCloudSearch(); showToast('å·²æ¸…ç©ºé€‰æ‹©'); }

    /* --- å¼¹çª—ä¸æ‰“å°é€»è¾‘ --- */
    function openImport(){document.getElementById('importModal').style.display='flex';}
    function closeImport(){document.getElementById('importModal').style.display='none';}
    function showToast(msg){ const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('active'); setTimeout(()=>t.classList.remove('active'), 1500); }

    function adjQty(n){ 
        const el = document.getElementById('globalQty'); 
        let v = parseInt(el.value)+n; 
        if(v<1)v=1; el.value=v; 
    }
    
    function openPrintModal() { 
        if(selectedIds.size === 0) return showToast('è¯·å…ˆé€‰æ‹©å•†å“');
        document.getElementById('printModal').style.display='flex'; 
        const list = document.getElementById('printListArea'); list.innerHTML = '';
        selectedIds.forEach(name => { list.innerHTML += `<div class="print-item">${name}</div>`; });
        
        setTimeout(()=>{
            const sel = document.getElementById('printerSelect');
            if(typeof getCLodop !== 'function') { sel.innerHTML='<option>âŒ æœªè¿æ¥C-Lodop</option>'; return; }
            try { 
                const LODOP = getCLodop(); const c = LODOP.GET_PRINTER_COUNT(); let h=''; 
                const saved = localStorage.getItem('DefaultPrinterIndex');
                for(let i=0;i<c;i++) h+=`<option value="${i}" ${saved==i?'selected':''}>${LODOP.GET_PRINTER_NAME(i)}</option>`;
                sel.innerHTML = h; 
            } catch(e) { sel.innerHTML='<option>âŒ é”™è¯¯</option>'; }
        }, 500);
    }
    function closePrint(){ document.getElementById('printModal').style.display='none'; }
    function quickDirectPrint() {
        if(selectedIds.size === 0) return showToast('è¯·å…ˆé€‰æ‹©');
        if(!localStorage.getItem('DefaultPrinterIndex')) return showToast('è¯·å…ˆè¿›å…¥è®¾ç½®é€‰æ‹©æ‰“å°æœº');
        confirmPrint('DIRECT');
    }

    // æ‰“å°é…ç½®ï¼šä¿æŒå¤§å­—å·
    const printConfig = [ 
        {type:'qrcode', x:2, y:2, w:22, h:22}, 
        // è¿™é‡Œä¹Ÿåšäº†å¾®è°ƒï¼Œè®©æ‰“å°å‡ºæ¥çš„åå­—å’Œåº“ä½çœ‹èµ·æ¥ä¹Ÿåè°ƒä¸€äº›
        {type:'text', val:'{å•†å“å}', x:26, y:5, w:32, h:12, fs:11, bold:true},
        {type:'text', val:'{ä¸»ä»“}', x:26, y:18, w:32, h:20, fs:24, bold:true},
        {type:'text', val:'{å‰¯ä»“}', x:26, y:34, w:32, h:6, fs:10, bold:true}
    ];

    function confirmPrint(mode) {
        if(typeof getCLodop !== 'function') return alert('æœªæ‰¾åˆ°æ‰“å°æœåŠ¡ (C-Lodop)');
        const LODOP = getCLodop();
        let pIdx = document.getElementById('printerSelect').value;
        if(mode === 'DIRECT') pIdx = localStorage.getItem('DefaultPrinterIndex');
        else localStorage.setItem('DefaultPrinterIndex', pIdx);

        const qty = parseInt(document.getElementById('globalQty').value) || 1;
        
        LODOP.PRINT_INIT("Cloud_Print_Task");
        if(pIdx) LODOP.SET_PRINTER_INDEX(pIdx);
        LODOP.SET_PRINT_PAGESIZE(1, "60mm", "40mm", ""); 

        selectedIds.forEach(name => {
            for(let i=0; i<qty; i++) {
                LODOP.NewPage();
                printConfig.forEach(el => {
                    if(el.type === 'qrcode') {
                        LODOP.ADD_PRINT_BARCODE(el.y, el.x, el.w, el.h, "QRCode", name);
                    } else {
                        let main='', sub='';
                        const items = document.querySelectorAll('.item');
                        items.forEach(it => {
                             if(it.querySelector('.item-name').innerText === name) {
                                 main = it.querySelectorAll('.tag-pill')[0]?.innerText.replace('ğŸ  ','') || '';
                                 sub = it.querySelectorAll('.tag-pill')[1]?.innerText.replace('ğŸ­ ','') || '';
                             }
                        });

                        let txt = el.val.replace('{å•†å“å}', name).replace('{ä¸»ä»“}', main).replace('{å‰¯ä»“}', sub);
                        LODOP.ADD_PRINT_TEXT(el.y, el.x, el.w, el.h, txt);
                        LODOP.SET_PRINT_STYLEA(0, "FontSize", el.fs);
                        if(el.bold) LODOP.SET_PRINT_STYLEA(0, "Bold", 1);
                    }
                });
            }
        });
        if(mode !== 'PREVIEW') { LODOP.PRINT(); showToast('æŒ‡ä»¤å·²å‘é€'); } else LODOP.PREVIEW();
        closePrint();
    }
</script>
</body>
</html>
