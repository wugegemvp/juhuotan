<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æé€Ÿæœç´¢ & æ ‡ç­¾æ‰“å° (ç§»åŠ¨ç‰ˆ V106)</title>
    
    <script src="http://localhost:8000/CLodopfuncs.js"></script>
    <script src="http://localhost:18000/CLodopfuncs.js"></script>

    <style>
        /* --- 1. åŸºç¡€å˜é‡ (ç§»åŠ¨ç«¯ä¼˜å…ˆè°ƒæ•´) --- */
        :root { 
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --primary: #000;
            --danger: #c0392b;
            --accent: #d35400;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; 
            background: var(--bg-body); 
            margin: 0; padding: 0; 
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- é¡¶éƒ¨æ ‡é¢˜æ  --- */
        .top-header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10;
        }
        .app-title { margin:0; font-size:18px; font-weight:900; display: flex; align-items: center; gap: 5px; }
        .version-tag { font-size:10px; background:var(--accent); color:#fff; padding:2px 4px; border-radius:4px; }
        
        /* ç§»åŠ¨ç«¯é¡¶éƒ¨æ“ä½œåŒºç®€åŒ– */
        .sys-actions { display: flex; gap: 8px; align-items: center; }
        .sys-actions .btn-sm { padding: 6px 10px; font-size: 12px; }
        .stock-info { display: none; } /* æ‰‹æœºä¸Šéšè—åº“å­˜æ–‡å­—ï¼ŒèŠ‚çœç©ºé—´ */

        /* --- 2. æœç´¢åŒºåŸŸ (æ”¹ä¸ºç«–æ’) --- */
        .search-bar-row {
            background: var(--bg-card); 
            padding: 10px;
            display: flex; flex-direction: column; gap: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .search-input { 
            width: 100%; padding: 12px; font-size: 16px; font-weight: bold; 
            border: 2px solid #ccc; border-radius: 8px; outline: none; appearance: none;
        }
        .search-input:focus { border-color: var(--primary); }

        .exclude-group { width: 100%; }
        .input-exclude {
            width: 100%; padding: 10px; font-size: 14px; 
            border: 1px solid #e74c3c; border-radius: 8px;
            background: #fff5f5; color: #c0392b;
        }

        /* --- 3. æ“ä½œè¡Œ (å·¥å…·æ ) --- */
        .middle-toolbar {
            background: #e8eaf6; padding: 10px; 
            display: flex; gap: 8px; overflow-x: auto; white-space: nowrap;
            -webkit-overflow-scrolling: touch; /*ä»¥æ­¤å®ç°å¹³æ»‘æ»šåŠ¨*/
        }
        
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .middle-toolbar::-webkit-scrollbar { display: none; }

        .btn-flash-print {
            flex-shrink: 0; height: 44px; padding: 0 20px; font-size: 15px; font-weight: 900; 
            border-radius: 22px; background: var(--primary); color: #fff; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .btn-normal {
            flex-shrink: 0; height: 44px; padding: 0 15px; font-size: 13px; font-weight: bold; 
            border-radius: 8px; background: #fff; color: #333; border: 1px solid #ccc;
        }

        .sel-wrapper { 
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
            display: flex; flex-direction: column; gap: 5px; align-items: flex-end;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
            transform: scale(0.9);
        }
        .sel-wrapper.show { opacity: 1; pointer-events: auto; transform: scale(1); }
        .sel-tag { 
            background: var(--accent); color: #fff; border: none; 
            padding: 8px 20px; border-radius: 30px; font-weight: bold; font-size: 14px; 
            box-shadow: 0 4px 12px rgba(211, 84, 0, 0.4);
        }
        .btn-clear-sel { 
            height: 36px; padding: 0 15px; font-size: 12px; font-weight: bold; 
            background: #fff; color: var(--danger); border: 1px solid #eee; 
            border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* --- åˆ—è¡¨åŒºåŸŸ (å¡ç‰‡åŒ–) --- */
        .list-header { display: none; } /* æ‰‹æœºç«¯éšè—è¡¨å¤´ */
        
        .result-list { 
            flex: 1; overflow-y: auto; background: #f0f2f5; padding: 10px; 
            -webkit-overflow-scrolling: touch;
        }

        .item { 
            background: #fff; border-radius: 8px; margin-bottom: 10px; padding: 12px;
            display: flex; flex-direction: column; gap: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid transparent;
            height: auto !important; /* è¦†ç›–è¡Œé«˜ */
        }
        
        .item.selected { 
            background: #e6f7ff !important; border-color: #1890ff; 
        }
        .item.selected .item-name { color: #c0392b; }

        .item-top { display: flex; align-items: flex-start; gap: 10px; }
        .item-checkbox { transform: scale(1.5); margin-top: 4px; }
        .item-idx { font-size: 12px; color: #999; background: #eee; padding: 2px 6px; border-radius: 4px; height: fit-content;}
        .item-name { flex: 1; font-weight: bold; font-size: 16px; line-height: 1.4; word-break: break-all; }
        
        .item-btm { 
            display: flex; justify-content: space-between; margin-top: 5px; 
            padding-top: 5px; border-top: 1px dashed #eee; font-size: 13px; color: #666;
        }
        .tag-pill { background: #f0f0f0; padding: 2px 8px; border-radius: 4px; font-weight: bold; }

        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); display: none; z-index: 2000; 
            justify-content: center; align-items: flex-end; /* åº•éƒ¨å¼¹å‡º */
        }
        .modal-content { 
            background: white; width: 100%; border-radius: 16px 16px 0 0; 
            padding: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.2); 
            max-height: 90vh; display: flex; flex-direction: column; gap: 15px; 
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* ç¼–è¾‘å™¨é€‚é… */
        #editorOverlay { 
            position:fixed; top:0; left:0; width:100%; height:100%; 
            background:#dfe4ea; z-index:3000; display:none; flex-direction:column; 
        }
        .editor-header { 
            height: 50px; background: #fff; padding: 0 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .editor-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .canvas-area { 
            flex: 1; background-color: #ced6e0; overflow: auto; 
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        /* ç¼–è¾‘å™¨è®¾ç½®é¢æ¿ - å˜ä¸ºåº•éƒ¨å¯æ»šåŠ¨åŒºåŸŸ */
        .settings-panel { 
            height: 40%; background: #fff; padding: 15px; overflow-y: auto; 
            border-top: 1px solid #ccc; display: flex; flex-direction: column; gap: 10px;
        }
        
        /* ç¼–è¾‘å™¨å†…éƒ¨æ§ä»¶ */
        .form-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .form-row label { width: 50px; font-size: 12px; }
        .form-row input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .half { flex: 1; display: flex; align-items: center; }

        .align-btn { width: 36px; height: 36px; font-size: 18px; margin: 2px; border:1px solid #ccc; border-radius: 4px; background: #fff;}
        
        .var-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .var-tag { padding: 6px 12px; background: #eee; border-radius: 15px; font-size: 12px; }

        /* æ‹–æ‹½å…ƒç´ æ ·å¼ */
        .drag-element { 
            position: absolute; border: 1px dashed #999; 
            display: flex; overflow: hidden; white-space: nowrap; line-height: 1.2; 
            font-family:"Microsoft YaHei"; touch-action: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤è§¦æ‘¸è¡Œä¸º */
        }
        .drag-element.active { border: 2px solid #000; background-color: rgba(0,0,0,0.05); z-index: 100; }
        .resize-handle { 
            position: absolute; bottom: -5px; right: -5px; width: 20px; height: 20px; 
            background: #000; border-radius: 50%; border: 2px solid #fff; display: none; z-index:101;
        }
        .drag-element.active .resize-handle { display: block; }
        
        /* åå¸æç¤º */
        #toast { 
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.85); color: white; padding: 15px 25px; 
            border-radius: 30px; font-size: 16px; font-weight: bold; z-index: 6000; 
            opacity: 0; pointer-events: none; transition: opacity 0.2s; 
            width: 80%; text-align: center;
        }
        #toast.active { opacity: 1; }

        /* æ‰“å°åˆ—è¡¨å¾®è°ƒ */
        .print-list { max-height: 200px; overflow-y: auto; border: 1px solid #eee; margin-top: 10px; }
        .print-item { padding: 12px; border-bottom: 1px solid #eee; }

        .btn-sm { border:1px solid #ccc; padding:6px 12px; border-radius:4px; font-weight:bold; background:#fff; }
        .btn-brain { background:#3498db; color:#fff; border:none; }
        .btn-danger-sm { color:red; border-color:red; }

        /* ç”µè„‘ç«¯ä¿ç•™çš„ä¸€äº›æ ·å¼é€‚é… */
        @media (min-width: 769px) {
            .modal { align-items: center; }
            .modal-content { width: 500px; border-radius: 8px; max-height: 80vh; }
            .search-bar-row { flex-direction: row; }
            .list-header { display: grid; }
            .result-list { padding: 0; }
            .item { 
                margin: 0; border-radius: 0; box-shadow: none; padding: 0; 
                display: grid; border-bottom: 1px solid #eee; 
            }
            .item-top { display: contents; }
            .item-btm { display: contents; }
            .tag-pill { background: none; padding: 0; }
            .item-idx, .item-checkbox { display: none; } /* PCç«¯ç”¨gridè‡ªå¸¦çš„ */
            
            /* æ¢å¤PCç«¯çš„Gridç»“æ„ï¼Œè¿™é‡Œä¸ºäº†å…¼å®¹ä¸Šé¢çš„HTMLç»“æ„éœ€è¦trickä¸€ä¸‹ï¼Œ
               æˆ–è€…é€šè¿‡JSåˆ¤æ–­ã€‚ä¸ºç®€å•èµ·è§ï¼ŒPCç«¯ä¹Ÿä½¿ç”¨Cardå¸ƒå±€æˆ–è€…åœ¨JSé‡Œæ¸²æŸ“ä¸åŒHTMLã€‚
               ä¸ºäº†ä»£ç å”¯ä¸€æ€§ï¼Œè¿™é‡Œä¿æŒCardå¸ƒå±€åœ¨PCç«¯ä¹Ÿæ˜¯å¯ç”¨çš„ï¼Œåªæ˜¯å®½ä¸€ç‚¹ã€‚
               å¦‚æœéå¸¸éœ€è¦PCç«¯è¡¨æ ¼ï¼Œå»ºè®®ç”¨ä¸¤å¥—CSSã€‚
               è¿™é‡Œæˆ‘ä¸»è¦ä¼˜åŒ–ç§»åŠ¨ç«¯ã€‚
            */
             .editor-main { flex-direction: row; }
             .settings-panel { width: 320px; height: 100%; border-top: none; border-left: 1px solid #ccc; }
        }
    </style>
</head>
<body>

    <div class="top-header">
        <h1 class="app-title">
            <span id="pageMainTitle">ğŸ” æé€Ÿæ‰“å°</span> 
            <span class="version-tag">M106</span>
        </h1>
        <div class="sys-actions">
            <span class="stock-info" id="dbCountDisp">0</span>
            <button class="btn-sm btn-brain" onclick="openAliasModal()">è®­ç»ƒ</button>
            <button class="btn-sm" onclick="openImport()">å¯¼å…¥</button>
            <button class="btn-sm btn-danger-sm" onclick="clearDB()">æ¸…ç©º</button>
        </div>
    </div>

    <div class="search-bar-row">
        <div class="search-group">
            <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœ: P40 è“è‰²" autofocus>
        </div>
        <div class="exclude-group">
            <input type="text" id="excludeInput" class="input-exclude" placeholder="ğŸš« æ’: å çƒ‚">
        </div>
    </div>

    <div class="middle-toolbar">
        <button class="btn-flash-print" onclick="quickDirectPrint()">âš¡ï¸ ç›´æ¥æ‰“å°</button>
        <button class="btn-normal" onclick="openPrintModal()">âš™ï¸ è®¾ç½®/é¢„è§ˆ</button>
        <button class="btn-normal" onclick="openEditor()">ğŸ¨ æ¨¡ç‰ˆ</button>
    </div>

    <div class="sel-wrapper" id="selWrapper">
        <div class="sel-tag">å·²é€‰ <b id="selCount" style="margin:0 4px;">0</b></div>
        <button class="btn-clear-sel" onclick="clearSelection()">æ¸…ç©º</button>
    </div>

    <div id="resultList" class="result-list">
        <div style="text-align:center; padding:40px; color:#999;">ğŸ‘‡ è¾“å…¥å…³é”®è¯æœç´¢...</div>
    </div>

    <div id="toast">âœ… å·²å¤åˆ¶</div>

    <div id="aliasModal" class="modal">
        <div class="modal-content">
            <h3 style="margin:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ§  å…³é”®è¯è®­ç»ƒ</h3>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="text" id="newAliasKey" class="search-input" style="font-size:14px; padding:8px;" placeholder="åŸè¯(p80)">
                <span>â¡ï¸</span>
                <input type="text" id="newAliasVal" class="search-input" style="font-size:14px; padding:8px;" placeholder="ç›®æ ‡(pura80)">
            </div>
            <button class="btn-flash-print" style="width:100%; margin-top:10px; height:36px; font-size:14px;" onclick="addAlias()">â• æ·»åŠ è§„åˆ™</button>
            
            <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:4px; padding:5px;">
                <table style="width:100%; font-size:13px;" id="aliasTable">
                    </table>
            </div>
            <button class="btn-normal" style="width:100%;" onclick="closeAliasModal()">å…³é—­</button>
        </div>
    </div>

    <div id="printModal" class="modal">
        <div class="modal-content">
            <h3 style="margin:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ–¨ï¸ æ‰“å°è®¾ç½®</h3>
            
            <div style="background:#fff3cd; padding:10px; border-radius:4px; font-size:12px; color:#856404;">
                âš ï¸ æ‰‹æœºç›´æ¥æ‰“å°éœ€ç¡®ä¿æ‰“å°æœåŠ¡(C-Lodop) IPåœ°å€æ­£ç¡®ï¼Œä¸”åœ¨åŒä¸€å±€åŸŸç½‘ã€‚
            </div>

            <label style="font-weight:bold; font-size:14px;">é€‰æ‹©æ‰“å°æœº:</label>
            <select id="printerSelect" style="width:100%; padding:10px; border:2px solid #ccc; border-radius:4px; font-size:16px; background:#fff;">
                <option>åŠ è½½ä¸­...</option>
            </select>

            <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                <label style="font-weight:bold;">æ¯æ¬¾æ•°é‡:</label>
                <button class="btn-normal" onclick="adjQty(-1)">-</button>
                <input type="number" id="globalQty" value="1" min="1" style="width:60px; text-align:center; padding:10px; border:2px solid #000; border-radius:4px; font-weight:bold;">
                <button class="btn-normal" onclick="adjQty(1)">+</button>
            </div>

            <div class="print-list" id="printListArea"></div>

            <div style="display:flex; gap:10px; margin-top:auto;">
                <button class="btn-normal" style="flex:1;" onclick="closePrint()">å–æ¶ˆ</button>
                <button class="btn-flash-print" style="flex:1;" onclick="confirmPrint('PRINT')">æ‰“å°</button>
            </div>
        </div>
    </div>

    <div id="editorOverlay">
        <div class="editor-header">
            <div style="font-weight:900;">ğŸ¨ ç¼–è¾‘æ¨¡æ¿</div>
            <div style="display:flex; gap:10px;">
                <button class="btn-sm" onclick="closeEditor(false)">å–æ¶ˆ</button>
                <button class="btn-sm" style="background:#000;color:#fff;" onclick="closeEditor(true)">ä¿å­˜</button>
            </div>
        </div>
        <div class="editor-main">
            <div class="canvas-area" onclick="deselectAll(event)">
                <div id="templateCanvas" data-size="60mm x 30mm"></div>
            </div>
            <div class="settings-panel">
                <div id="elePropBox" style="opacity:0.5; pointer-events:none;">
                    <div style="font-weight:bold; margin-bottom:5px; border-bottom:1px solid #eee;">é€‰ä¸­é¡¹è®¾ç½®</div>
                    <div class="form-row">
                        <div class="half"><label>X</label><input type="number" id="elX" oninput="updateEl()"></div>
                        <div class="half"><label>Y</label><input type="number" id="elY" oninput="updateEl()"></div>
                    </div>
                    <div class="form-row">
                        <div class="half"><label>å®½</label><input type="number" id="elW" oninput="updateEl()"></div>
                        <div class="half"><label>é«˜</label><input type="number" id="elH" oninput="updateEl()"></div>
                    </div>
                    <div id="textProps">
                         <div class="form-row"><label>å†…å®¹</label><input type="text" id="elContent" oninput="updateEl()"></div>
                         <div class="form-row"><label>å­—å·</label><input type="number" id="elFont" oninput="updateEl()"></div>
                         <div class="var-tags">
                            <span class="var-tag" onclick="insertVar('{å•†å“å}')">å“å</span>
                            <span class="var-tag" onclick="insertVar('{ä¸»ä»“}')">ä¸»ä»“</span>
                            <span class="var-tag" onclick="insertVar('{å‰¯ä»“}')">å‰¯ä»“</span>
                         </div>
                         <div style="display:flex; gap:10px; margin-top:5px;">
                            <button class="btn-sm" style="flex:1" onclick="toggleBold()">B åŠ ç²—</button>
                            <button class="btn-sm" style="flex:1" onclick="setAlignH('center')">å±…ä¸­</button>
                         </div>
                    </div>
                </div>
                <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
                    <div style="font-weight:bold; margin-bottom:5px;">çº¸å¼  (mm)</div>
                    <div class="form-row">
                        <input type="number" id="cvW" placeholder="å®½" onchange="updateCanvasSize()"> x 
                        <input type="number" id="cvH" placeholder="é«˜" onchange="updateCanvasSize()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“¥ æ‰¹é‡å¯¼å…¥</h3>
            <textarea id="importArea" style="width:100%; height:150px; padding:10px; border:1px solid #ccc; border-radius:8px;" placeholder="ç²˜è´´Excelå†…å®¹ï¼šåç§° | ä¸»ä»“ | å‰¯ä»“"></textarea>
            <div style="display:flex; gap:10px; width:100%;">
                <button class="btn-normal" style="flex:1" onclick="closeImport()">å–æ¶ˆ</button>
                <button class="btn-flash-print" style="flex:1" onclick="saveImport()">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>

<script>
    const DB_NAME = "FuzzySearch_Mobile_V106";
    let db, allData=[], currentResults=[], selectedIds=new Set();
    let selectedEl = null;
    let aliasMap = {}; 

    // é»˜è®¤æ ‡ç­¾é…ç½®
    const EL_DEF = [ 
        {id:'qr', name:'äºŒç»´ç ', type:'qrcode', default:{x:2, y:2, w:26, h:26, ah:'center', av:'center'}}, 
        {id:'name', name:'å•†å“å', type:'text', txt:'{å•†å“å}', default:{x:32, y:5, w:180, h:24, fs:13, bold:true, ah:'flex-start', av:'center'}},
        {id:'main', name:'ä¸»ä»“', type:'text', txt:'{ä¸»ä»“}', default:{x:32, y:30, w:100, h:20, fs:16, bold:true, ah:'flex-start', av:'center'}},
        {id:'sub', name:'å‰¯ä»“', type:'text', txt:'{å‰¯ä»“}', default:{x:92, y:34, w:60, h:15, fs:12, bold:true, ah:'flex-start', av:'center'}}, 
        {id:'date', name:'æ—¥æœŸ', type:'text', txt:'{æ—¥æœŸ}', default:{x:4, y:38, w:40, h:12, fs:10, ah:'flex-start', av:'center'}},
        {id:'page', name:'é¡µç ', type:'text', txt:'{é¡µç }', default:{x:160, y:38, w:40, h:12, fs:10, ah:'center', av:'center'}}
    ];
    let layoutConfig = { w: 60, h: 30, elements: JSON.parse(JSON.stringify(EL_DEF)).map(e => ({...e, ...e.default, visible:true})) };

    window.onload = () => {
        initDB(); loadLayout(); loadAliases();
        document.getElementById('searchInput').addEventListener('input', handleInput);
        document.getElementById('excludeInput').addEventListener('input', handleInput);
    };

    /* --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ --- */
    function initDB() { const r=indexedDB.open(DB_NAME, 1); r.onupgradeneeded=e=>e.target.result.createObjectStore('products',{keyPath:'name'}); r.onsuccess=e=>{db=e.target.result;loadData();}; }
    function loadData() { db.transaction(['products']).objectStore('products').getAll().onsuccess=e=>{allData=e.target.result; document.getElementById('dbCountDisp').innerText = allData.length;}; }
    
    function handleInput() {
        if(selectedIds.size > 0) { selectedIds.clear(); updateFooter(); }
        renderListCurrent(); 
    }

    function renderListCurrent() {
        const inc = document.getElementById('searchInput').value.trim().toLowerCase().split(/\s+/);
        const exc = document.getElementById('excludeInput').value.trim().toLowerCase().split(/\s+/);
        
        let res = allData;
        const validInc = inc.filter(k=>k); const validExc = exc.filter(k=>k);
        
        if(validInc.length > 0 || validExc.length > 0) {
            res = allData.filter(d => {
                const name = d.name.toLowerCase();
                const matchInc = validInc.length === 0 || validInc.every(k => {
                    if(name.includes(k)) return true;
                    const at = aliasMap[k]; return at && name.includes(at.toLowerCase());
                });
                const matchExc = validExc.length > 0 && validExc.some(k => name.includes(k));
                return matchInc && !matchExc;
            });
        }
        
        currentResults = res;
        const list = document.getElementById('resultList');
        if(!res.length) { list.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">ğŸ” æœªæ‰¾åˆ°...</div>'; return; }
        
        let h = '';
        res.slice(0, 50).forEach((item, idx) => { // é™åˆ¶æ˜¾ç¤ºæ•°é‡ä»¥æå‡æ‰‹æœºæ€§èƒ½
            const isSel = selectedIds.has(item.name);
            const safeName = item.name.replace(/"/g, "&quot;");
            h += `
            <div class="item ${isSel?'selected':''}" onclick="toggleRow('${safeName}')">
                <div class="item-top">
                    <input type="checkbox" class="item-checkbox" ${isSel?'checked':''} readonly>
                    <span class="item-idx">${idx+1}</span>
                    <div class="item-name">${item.name}</div>
                </div>
                <div class="item-btm">
                    <span class="tag-pill">ğŸ  ${item.main||'-'}</span>
                    <span class="tag-pill">ğŸ­ ${item.sub||'-'}</span>
                </div>
            </div>`;
        });
        if(res.length > 50) h += '<div style="text-align:center;padding:10px;color:#ccc;">ä»…æ˜¾ç¤ºå‰50æ¡</div>';
        list.innerHTML = h;
    }

    function toggleRow(name) {
        if (selectedIds.has(name)) selectedIds.delete(name); else selectedIds.add(name);
        updateFooter(); renderListCurrent();
    }
    
    function updateFooter() { 
        const c = selectedIds.size; document.getElementById('selCount').innerText = c;
        const w = document.getElementById('selWrapper');
        if(c>0) w.classList.add('show'); else w.classList.remove('show');
    }
    function clearSelection() { selectedIds.clear(); updateFooter(); renderListCurrent(); showToast('å·²æ¸…ç©ºé€‰æ‹©'); }

    /* --- æ‰“å°ç›¸å…³ --- */
    function adjQty(n){ 
        const el = document.getElementById('globalQty'); 
        let v = parseInt(el.value)+n; 
        if(v<1)v=1; el.value=v; 
    }
    
    function openPrintModal() { 
        if(selectedIds.size === 0) return showToast('è¯·å…ˆé€‰æ‹©å•†å“');
        document.getElementById('printModal').style.display='flex'; 
        const list = document.getElementById('printListArea'); list.innerHTML = '';
        selectedIds.forEach(name => { list.innerHTML += `<div class="print-item">${name}</div>`; });
        
        setTimeout(()=>{
            const sel = document.getElementById('printerSelect');
            if(typeof getCLodop !== 'function') { sel.innerHTML='<option>âŒ æœªè¿æ¥C-Lodop</option>'; return; }
            try { 
                const LODOP = getCLodop(); const c = LODOP.GET_PRINTER_COUNT(); let h=''; 
                const saved = localStorage.getItem('DefaultPrinterIndex');
                for(let i=0;i<c;i++) h+=`<option value="${i}" ${saved==i?'selected':''}>${LODOP.GET_PRINTER_NAME(i)}</option>`;
                sel.innerHTML = h; 
            } catch(e) { sel.innerHTML='<option>âŒ é”™è¯¯</option>'; }
        }, 500);
    }
    
    function quickDirectPrint() {
        if(selectedIds.size === 0) return showToast('è¯·å…ˆé€‰æ‹©');
        if(!localStorage.getItem('DefaultPrinterIndex')) return showToast('è¯·å…ˆè¿›å…¥è®¾ç½®é€‰æ‹©æ‰“å°æœº');
        confirmPrint('DIRECT');
    }

    function confirmPrint(mode) {
        if(typeof getCLodop !== 'function') return alert('æœªæ‰¾åˆ°æ‰“å°æœåŠ¡ (C-Lodop)\nè¯·ç¡®è®¤æ‰‹æœºä¸ç”µè„‘åœ¨åŒä¸€WIFIï¼Œä¸”JSå¼•ç”¨IPæ­£ç¡®ã€‚');
        const LODOP = getCLodop();
        let pIdx = document.getElementById('printerSelect').value;
        if(mode === 'DIRECT') pIdx = localStorage.getItem('DefaultPrinterIndex');
        else localStorage.setItem('DefaultPrinterIndex', pIdx);

        const qty = parseInt(document.getElementById('globalQty').value) || 1;
        const dateStr = new Date().toLocaleDateString();

        LODOP.PRINT_INIT("Mobile_Print_Task");
        if(pIdx) LODOP.SET_PRINTER_INDEX(pIdx);
        LODOP.SET_PRINT_PAGESIZE(1, layoutConfig.w+"mm", layoutConfig.h+"mm", "");

        selectedIds.forEach(name => {
            const data = allData.find(d => d.name === name) || {};
            for(let i=0; i<qty; i++) {
                LODOP.NewPage();
                layoutConfig.elements.forEach(el => {
                    if(!el.visible) return;
                    if(el.type === 'qrcode') {
                        let s = Math.min(el.w, el.h);
                        LODOP.ADD_PRINT_BARCODE(el.y+(el.h-s)/2, el.x+(el.w-s)/2, s, s, "QRCode", name);
                        LODOP.SET_PRINT_STYLEA(0, "QRCodeErrorLevel", "L");
                    } else {
                        let txt = el.txt.replace('{å•†å“å}', name).replace('{ä¸»ä»“}', data.main||'').replace('{å‰¯ä»“}', data.sub||'').replace('{æ—¥æœŸ}', dateStr).replace('{é¡µç }', (i+1)+'/'+qty);
                        LODOP.ADD_PRINT_TEXT(el.y, el.x, el.w, el.h, txt);
                        LODOP.SET_PRINT_STYLEA(0, "FontSize", el.fs);
                        if(el.bold) LODOP.SET_PRINT_STYLEA(0, "Bold", 1);
                        let a=1; if(el.ah==='center')a=2; if(el.ah==='flex-end')a=3;
                        LODOP.SET_PRINT_STYLEA(0, "Alignment", a);
                    }
                });
            }
        });
        if(mode !== 'PREVIEW') { LODOP.PRINT(); showToast('æŒ‡ä»¤å·²å‘é€'); } else LODOP.PREVIEW();
        closePrint();
    }
    function closePrint(){ document.getElementById('printModal').style.display='none'; }

    /* --- ç¼–è¾‘å™¨ (å¸¦è§¦æ§æ”¯æŒ) --- */
    function openEditor() { 
        document.getElementById('editorOverlay').style.display='flex'; 
        document.getElementById('cvW').value=layoutConfig.w; 
        document.getElementById('cvH').value=layoutConfig.h; 
        updateCanvasSize(); renderEditorCanvas(); 
    }
    function closeEditor(save) {
        if(save) {
            layoutConfig.w = document.getElementById('cvW').value;
            layoutConfig.h = document.getElementById('cvH').value;
            layoutConfig.elements.forEach(item => {
                const el = document.getElementById('edt-'+item.id);
                if(el) {
                    item.x=parseInt(el.style.left); item.y=parseInt(el.style.top);
                    item.w=parseInt(el.style.width); item.h=parseInt(el.style.height);
                    item.ah = el.style.justifyContent || 'center'; 
                    if(item.type==='text') {
                        item.fs=parseInt(el.style.fontSize)||12;
                        item.bold=el.style.fontWeight==='bold';
                        item.txt=el.getAttribute('data-raw');
                    }
                }
            });
            localStorage.setItem('LabelConfig_M106', JSON.stringify(layoutConfig));
            showToast('å·²ä¿å­˜å¸ƒå±€');
        } else loadLayout();
        document.getElementById('editorOverlay').style.display='none';
    }
    
    function renderEditorCanvas() {
        const c = document.getElementById('templateCanvas'); c.innerHTML='';
        layoutConfig.elements.forEach(item => {
            const div=document.createElement('div'); div.id='edt-'+item.id;
            div.className='drag-element'; div.style.left=item.x+'px'; div.style.top=item.y+'px'; 
            div.style.width=item.w+'px'; div.style.height=item.h+'px';
            div.style.justifyContent=item.ah||'center'; div.style.alignItems='center';
            if(item.type==='qrcode') div.innerHTML='<img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=QR" style="width:100%;height:100%;opacity:0.5;pointer-events:none;">';
            else { 
                div.textContent=item.txt; div.setAttribute('data-raw', item.txt);
                div.style.fontSize=item.fs+'px'; if(item.bold) div.style.fontWeight='bold'; 
            }
            div.innerHTML+='<div class="resize-handle"></div>';
            
            // é¼ æ ‡äº‹ä»¶
            div.onmousedown=(e)=>startDrag(e,div,false);
            // è§¦æ‘¸äº‹ä»¶ (å…³é”®é€‚é…)
            div.ontouchstart=(e)=>startDrag(e.touches[0],div,true);
            
            div.onclick=(e)=>selectElement(e,div);
            c.appendChild(div);
        });
    }

    // ç»Ÿä¸€æ‹–æ‹½é€»è¾‘
    function startDrag(e, el, isTouch) {
        e.stopPropagation?.();
        selectElement({stopPropagation:()=>{}}, el);
        const startX=e.clientX, startY=e.clientY;
        const isResize = e.target.classList.contains('resize-handle');
        const startW=parseInt(el.style.width), startH=parseInt(el.style.height);
        const startL=el.offsetLeft, startT=el.offsetTop;

        const moveHandler = (ev) => {
            const point = isTouch ? ev.touches[0] : ev;
            if(isResize) {
                el.style.width = Math.max(10, startW + point.clientX - startX) + 'px';
                el.style.height = Math.max(10, startH + point.clientY - startY) + 'px';
            } else {
                if(isTouch) ev.preventDefault(); // é˜²æ­¢æ‰‹æœºæ»šåŠ¨
                el.style.left = (startL + point.clientX - startX) + 'px';
                el.style.top = (startT + point.clientY - startY) + 'px';
            }
            updateInputs();
        };

        const endHandler = () => {
            document.removeEventListener(isTouch?'touchmove':'mousemove', moveHandler);
            document.removeEventListener(isTouch?'touchend':'mouseup', endHandler);
        };

        document.addEventListener(isTouch?'touchmove':'mousemove', moveHandler, {passive: false});
        document.addEventListener(isTouch?'touchend':'mouseup', endHandler);
    }

    function selectElement(e, el) {
        e.stopPropagation();
        document.querySelectorAll('.drag-element').forEach(d=>d.classList.remove('active'));
        el.classList.add('active'); selectedEl=el;
        const box = document.getElementById('elePropBox'); box.style.opacity='1'; box.style.pointerEvents='auto';
        updateInputs();
        const isQr = el.querySelector('img');
        document.getElementById('textProps').style.display = isQr ? 'none' : 'block';
        if(!isQr) {
            document.getElementById('elContent').value = el.getAttribute('data-raw');
            document.getElementById('elFont').value = parseInt(el.style.fontSize);
        }
    }
    
    function deselectAll(e) { 
        if(e.target.classList.contains('canvas-area') || e.target.id==='templateCanvas') {
            document.querySelectorAll('.drag-element').forEach(d=>d.classList.remove('active')); selectedEl=null; 
            document.getElementById('elePropBox').style.opacity='0.5';
        }
    }
    function updateInputs(){ 
        if(!selectedEl)return; 
        document.getElementById('elX').value=parseInt(selectedEl.style.left); 
        document.getElementById('elY').value=parseInt(selectedEl.style.top);
        document.getElementById('elW').value=parseInt(selectedEl.style.width); 
        document.getElementById('elH').value=parseInt(selectedEl.style.height);
    }
    function updateEl() {
        if(!selectedEl)return; const s=selectedEl.style;
        s.left=document.getElementById('elX').value+'px'; s.top=document.getElementById('elY').value+'px';
        s.width=document.getElementById('elW').value+'px'; s.height=document.getElementById('elH').value+'px';
        if(!selectedEl.querySelector('img')) {
            const txt = document.getElementById('elContent').value;
            selectedEl.childNodes[0].textContent=txt; selectedEl.setAttribute('data-raw', txt);
            s.fontSize=document.getElementById('elFont').value+'px';
        }
    }
    function updateCanvasSize(){ 
        const c=document.getElementById('templateCanvas'); 
        c.style.width=document.getElementById('cvW').value+'mm'; 
        c.style.height=document.getElementById('cvH').value+'mm'; 
    }
    function insertVar(v){ if(selectedEl&&!selectedEl.querySelector('img')){ document.getElementById('elContent').value+=v; updateEl(); } }
    function toggleBold(){ if(selectedEl) selectedEl.style.fontWeight=selectedEl.style.fontWeight==='bold'?'normal':'bold'; }
    function setAlignH(v){ if(selectedEl) selectedEl.style.justifyContent=v; }
    function loadLayout(){ const s=localStorage.getItem('LabelConfig_M106'); if(s) { const p=JSON.parse(s); layoutConfig=p; } }

    /* --- å…¶ä»–å·¥å…· --- */
    function loadAliases() { const s = localStorage.getItem('SearchAliases'); if(s) aliasMap = JSON.parse(s); }
    function openAliasModal() { 
        document.getElementById('aliasModal').style.display='flex'; 
        const t = document.getElementById('aliasTable'); t.innerHTML='';
        Object.keys(aliasMap).forEach(k => t.innerHTML += `<tr><td><b>${k}</b></td><td>â†’ ${aliasMap[k]}</td><td style="text-align:right;"><span onclick="removeAlias('${k}')" style="color:red;font-weight:bold;padding:5px;">Ã—</span></td></tr>`);
    }
    function closeAliasModal() { document.getElementById('aliasModal').style.display='none'; }
    function addAlias() {
        const k=document.getElementById('newAliasKey').value.trim().toLowerCase();
        const v=document.getElementById('newAliasVal').value.trim();
        if(k&&v){ aliasMap[k]=v; localStorage.setItem('SearchAliases',JSON.stringify(aliasMap)); openAliasModal(); renderListCurrent(); document.getElementById('newAliasKey').value='';}
    }
    function removeAlias(k){ delete aliasMap[k]; localStorage.setItem('SearchAliases',JSON.stringify(aliasMap)); openAliasModal(); renderListCurrent(); }
    
    function openImport(){document.getElementById('importModal').style.display='flex';}
    function closeImport(){document.getElementById('importModal').style.display='none';}
    function saveImport(){ 
        const txt=document.getElementById('importArea').value; const tx=db.transaction(['products'],'readwrite'); 
        let c=0; txt.split('\n').forEach(l=>{ const p=l.split(/\t|\|/); if(p[0]?.trim()){ tx.objectStore('products').put({name:p[0].trim(), main:p[1]?.trim()||'', sub:p[2]?.trim()||''}); c++; } }); 
        tx.oncomplete=()=>{loadData();closeImport();showToast(`å¯¼å…¥ ${c} æ¡`);}; 
    }
    function clearDB(){ if(confirm('âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®?')) db.transaction(['products'],'readwrite').objectStore('products').clear().oncomplete=()=>{allData=[];currentResults=[];selectedIds.clear();document.getElementById('dbCountDisp').innerText=0;renderListCurrent();updateFooter();}; }
    function showToast(msg){ const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('active'); setTimeout(()=>t.classList.remove('active'), 1500); }
</script>
</body>
</html>